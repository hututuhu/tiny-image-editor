(self.webpackChunktiny_image_editor=self.webpackChunktiny_image_editor||[]).push([[433],{57825:function(Rr,Re,D){"use strict";D.r(Re),D.d(Re,{default:function(){return gr}});var p=D(67294),De=D(9783),S=D.n(De),K,oe,ie={OBJECT_ACTIVATED:"objectActivated",OBJECT_MOVED:"objectMoved",OBJECT_SCALED:"objectScaled",OBJECT_CREATED:"objectCreated",TEXT_EDITING:"textEditing",TEXT_CHANGED:"textChanged",ICON_CREATE_RESIZE:"iconCreateResize",ICON_CREATE_END:"iconCreateEnd",ADD_TEXT:"addText",ADD_OBJECT:"addObject",ADD_OBJECT_AFTER:"addObjectAfter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_MOVE:"mousemove",REDO_STACK_CHANGED:"redoStackChanged",UNDO_STACK_CHANGED:"undoStackChanged",SELECTION_CLEARED:"selectionCleared",SELECTION_CREATED:"selectionCreated"},f=function(u){return u.crop="crop",u.history="history",u.download="download",u.draw="draw",u.flip="flip",u.reset="reset",u.rotate="rotate",u.rect="rect",u.circle="circle",u.text="text",u.upload="upload",u.drag="drag",u.scale="scale",u.arrow="arrow",u.mosaic="mosaic",u.default="",u}({}),we=(K={},S()(K,f.crop,"\u88C1\u526A"),S()(K,f.history,"\u5386\u53F2\u8BB0\u5F55"),S()(K,f.download,"\u4E0B\u8F7D"),S()(K,f.draw,"\u753B\u7B14"),S()(K,f.flip,"\u7FFB\u8F6C"),S()(K,f.reset,"\u91CD\u7F6E"),S()(K,f.rotate,"\u65CB\u8F6C"),S()(K,f.rect,"\u77E9\u5F62"),S()(K,f.circle,"\u5706\u5F62"),S()(K,f.text,"\u6587\u672C"),S()(K,f.upload,"\u4E0A\u4F20"),S()(K,f.drag,"\u62D6\u62FD"),S()(K,f.scale,"\u7F29\u653E"),S()(K,f.arrow,"\u7BAD\u5934"),S()(K,f.mosaic,"\u9A6C\u8D5B\u514B"),K),J=function(u){return u.add="add",u.modified="modified",u.delete="delete",u}({}),Ie=(oe={},S()(oe,J.add,"\u6DFB\u52A0"),S()(oe,J.modified,"\u4FEE\u6539"),S()(oe,J.delete,"\u5220\u9664"),oe),de=function(u){return u.flipX="flipX",u.flipY="flipY",u}({}),fe="workspace",ae=function(u){return u.size="size",u.color="color",u}({}),X={sizes:[5,10,20],colors:["red","orange","yellow","green","blue","white"],fontSizes:[30,60,90],rotates:[0,45,90,135,180,225,270,315,360],mosaicSizes:[10,20,30]},ve={Z:90,Y:89,SHIFT:16,BACKSPACE:8,DEL:46},xe="tie_image_editor",wr=8,ge=["id","gradientAngle","selectable","hasControls","source","editable"],Pe=30,Ee="",Oe=[],_e=["onChange","loadData","onClick","onSelect","options","name","value","defaultValue","values","defaultValues","placeholder","large","small","iconRender","icon","activeIndex","swipeAble","fixedArrows","error","onVisibleChange"],G=p.createContext({canvasInstanceRef:{current:null},wrapperInstanceRef:{current:null},currentMenuRef:{current:f.default},currentMenu:f.default,setCurrentMenu:function(){},canvasIsRender:!1,canvasEl:{current:null},initCanvasJson:{current:null},unSaveHistory:{current:null},historyRef:{current:function(){}},initBackGroundImage:function(){},zoom:1,setZoom:function(){}}),Ae=function(){return!!(window.File&&window.FileList&&window.FileReader)},Ne=function(e){var t=/data:(image\/.+);base64,/,r="",a,o,i;a=e.replace(t,function(v,c){return r=c,""}),a=atob(a);var h=a.length;for(o=new Uint8Array(h),i=0;i<h;i+=1)o[i]=a.charCodeAt(i);return new Blob([o],{type:r})},q=function(e,t,r){if(t>r){var a=[r,t];t=a[0],r=a[1]}return Math.max(t,Math.min(e,r))},ze=function(e,t){var r=Object.assign({},e);return t.forEach(function(a){delete r[a]}),r};function Fe(u){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return e=e.concat(_e),ze(u,e)}var xr=function(){if(navigator){var e=navigator.userAgent,t=e.indexOf("Trident")>-1&&e.indexOf("rv:11.0")>-1;if(t)return 11;var r=navigator.appVersion.split(";")[1];if(!r)return;var a=r.replace(/[ ]/g,""),o=/MSIE(\d+)\./.exec(a);if(o)return parseInt(o[1])}},Be=D(94184),O=D.n(Be),b=D(32777),Le=D(97857),z=D.n(Le),He=D(19632),We=D.n(He),Xe=D(13769),Je=D.n(Xe),Ue=D(5574),re=D.n(Ue),Ye=D(70614),Ve=D(81385),Ke=D(63351),Ge=D(12444),Ze=D.n(Ge),$e=D(72004),Qe=D.n($e),qe=D(25098),ye=D.n(qe),et=D(31996),tt=D.n(et),rt=D(26037),nt=D.n(rt),at=D(73935),it=function(u){tt()(t,u);var e=nt()(t);function t(r){var a;return Ze()(this,t),a=e.call(this,r),S()(ye()(a),"container",null),a.container=null,a.getContainer=a.getContainer.bind(ye()(a)),a}return Qe()(t,[{key:"componentDidMount",value:function(){var a=this;this.container=this.props.container||document.body,this.forceUpdate(function(){a.props.onRendered&&a.props.onRendered()})}},{key:"componentDidUpdate",value:function(a){a.container!==this.props.container&&(this.container=this.props.container||null)}},{key:"getContainer",value:function(){return this.container}},{key:"render",value:function(){var a=this.props.children;return this.container&&a?at.createPortal(a,this.container):null}}]),t}(p.Component),n=D(85893),ot=["className","style","children","trigger","visible","popoverClassName","popoverStyle","showArrow","content","placement","usePortal","portalContainer","positionFixed","modifiers","outlineColor","backgroundColor","scheduleUpdate","onOpenChange","maskClosable"],st=function(e){return(0,n.jsx)("div",{className:"popper__arrow",style:S()({},"border"+e.arrowPlacement+"-color",e.backgroundColor),children:e.children})},Me=function(e){var t=(0,p.useRef)(null),r=(0,p.useRef)(null),a=(0,p.useState)(e.open),o=re()(a,2),i=o[0],h=o[1],v=e.className,c=e.style,l=e.children,d=e.trigger,g=e.visible,m=e.popoverClassName,w=e.popoverStyle,C=e.showArrow,s=e.content,R=e.placement,x=e.usePortal,k=e.portalContainer,N=e.positionFixed,j=e.modifiers,E=e.outlineColor,F=e.backgroundColor,U=e.scheduleUpdate,Y=e.onOpenChange,y=e.maskClosable,M=y===void 0?!0:y,T=Je()(e,ot),L=Fe(T,["popoverClassName","popoverStyle","showArrow","content","usePortal","positionFixed","outlineColor","backgroundColor","getPopoverRef","onOpenChange"]),I=function(_){Y&&Y(_),e.open!==void 0?h(e.open):h(_)},P=function(_){var Q,ne;!t||!r||(Q=t.current)!==null&&Q!==void 0&&Q.contains(_.target)||(ne=r.current)!==null&&ne!==void 0&&ne.contains(_.target)||M&&I(!1)},B=function(){var _=e.open,Q=e.onOpenChange;_!==void 0&&Q===void 0||d==="hover"&&I(!0)},V=function(){var _=e.open,Q=e.onOpenChange;_!==void 0&&Q===void 0||d==="hover"&&I(!1)},H=function(_){if(_.nativeEvent.stopImmediatePropagation(),d==="click"){I(!i);return}d==="focus"&&I(!0)};(0,p.useEffect)(function(){e.getPopoverRef&&e.getPopoverRef(t)},[]),(0,p.useEffect)(function(){return(d==="click"||d==="focus")&&document.body.addEventListener("click",P,!1),function(){document.body.removeEventListener("click",P,!1)}},[M,e.open]),(0,p.useEffect)(function(){e.open!==void 0&&I(e.open)},[e.open]);var ee=function(){var _=N?"fixed":"absolute",Q=[{name:"computeStyles",options:{gpuAcceleration:!1}},{name:"offset",options:{offset:[0,10]}}],ne=function(te){if(te)return te.split("-")[0].toString().replace(/^\S/,function(Ce){return Ce.toUpperCase()})},Z=function(te){if(te==="content"&&E)return{borderColor:E};if(te==="arrow"&&E)return S()({},"border".concat(ne(R),"Color"),E)},ue=function(){if(F)return{color:"#fff",background:F}},le=R.split("-")[0],Te=i&&(0,n.jsx)(Ye.r,{placement:R,modifiers:[].concat(Q,We()(j||[])),strategy:_,children:function(te){var Ce=te.ref,pr=te.style,mr=te.placement,be=te.arrowProps,Cr=te.update;return(0,p.useEffect)(function(){i&&Cr()},[U]),(0,n.jsx)("div",{className:O()("tie-popover__popper",m,{"tie-popover__popper-background":F}),style:z()(z()(z()(z()({},pr),w),Z("content")),ue()),ref:Ce,"x-placement":mr,onMouseEnter:B,onMouseLeave:V,children:(0,n.jsxs)("div",{ref:t,children:[i&&(0,n.jsx)("div",{className:"tie-popover__content",children:(0,n.jsx)("span",{children:s})}),C&&(0,n.jsx)(st,{arrowPlacement:le,backgroundColor:F,children:(0,n.jsx)("div",{"data-popper-arrow":!0,className:"tie-popper__arrow popper__arrow","x-arrow":"true",style:z()(z()({},be.style),Z("arrow")),ref:be.ref})})]})})}});return x?(0,n.jsx)(it,{container:k,children:Te}):Te},$=function(_){if(_.type.__BRICKS_BUTTON&&_.props.disabled){var Q=_.props.style&&_.props.style.display?_.props.style.display:"inline-block",ne=p.cloneElement(_,{style:z()(z()({},_.props.style),{},{pointerEvents:"none"})});return(0,n.jsx)("span",{style:{display:Q,cursor:"not-allowed"},children:ne})}return _};return(0,n.jsx)(n.Fragment,{children:g?(0,n.jsx)("div",z()(z()({className:O()("tie-popover",v)},L),{},{style:c,children:(0,n.jsxs)(Ve.dK,{children:[(0,n.jsx)(Ke.s,{children:function(_){var Q=_.ref;return(0,n.jsx)("div",{ref:r,className:"tie-popover__target",children:(0,n.jsx)("div",{ref:Q,children:p.Children.map(l,function(ne){var Z=ne;return Z=$(Z),d==="click"?p.cloneElement(Z,{onClick:function(le){H(le),Z.props.onClick&&Z.props.onClick()}}):d==="focus"?p.cloneElement(Z,{onFocus:function(le){H(le),Z.props.onFocus&&Z.props.onFocus()}}):d==="hover"?p.cloneElement(Z,{onMouseEnter:function(){B(),Z.props.onMouseEnter&&Z.props.onMouseEnter()},onMouseLeave:function(){V(),Z.props.onMouseLeave&&Z.props.onMouseLeave()}}):Z})})})}}),ee()]})})):l})};Me.defaultProps={visible:!0,trigger:"hover",placement:"bottom",showArrow:!0,usePortal:!0,modifiers:[]};var A=Me,ct=function(e){var t=e.children,r=e.open,a=r===void 0?!1:r,o=e.type,i=e.onChange,h=function(c,l){i&&i(c,l)};return(0,n.jsx)(A,{content:(0,n.jsxs)("div",{className:"tie-image-editor_tool-paint-content",children:[(0,n.jsx)("div",{className:"tie-image-editor_tool-paint-size-wrapper",children:(o===f.text?X.fontSizes:X.sizes).map(function(v,c){return(0,n.jsx)("div",{onClick:function(){return h(ae.size,v)},className:"tie-image-editor_tool-paint-size",style:{width:10+c*5,height:10+c*5}},v)})}),(0,n.jsx)("div",{className:"tie-image-editor_tool-paint-color-wrapper",children:X.colors.map(function(v){return(0,n.jsx)("div",{onClick:function(){return h(ae.color,v)},className:"tie-image-editor_tool-paint-color",style:{background:v}},v)})})]}),placement:"bottom",open:a,children:(0,n.jsx)("div",{children:t})})},se=ct;b.fabric.Arrow=b.fabric.util.createClass(b.fabric.Line,{type:"arrow",superType:"drawing",initialize:function(e,t){if(!e){var r=t,a=r.x1,o=r.x2,i=r.y1,h=r.y2;e=[a,i,o,h]}t=t||{},this.callSuper("initialize",e,t)},_render:function(e){this.callSuper("_render",e),e.save();var t=this.x2-this.x1,r=this.y2-this.y1,a=Math.atan2(r,t);e.translate((this.x2-this.x1)/2,(this.y2-this.y1)/2),e.rotate(a),e.beginPath(),e.moveTo(this.strokeWidth*2,0),e.lineTo(-this.strokeWidth*2,this.strokeWidth*2),e.lineTo(-this.strokeWidth*2,-this.strokeWidth*2),e.closePath(),e.fillStyle=this.stroke,e.fill(),e.restore()}}),b.fabric.Arrow.fromObject=function(u,e){var t=u.x1,r=u.x2,a=u.y1,o=u.y2;return e(new b.fabric.Arrow([t,a,r,o],u))};var ut=function(){var e=(0,p.useContext)(G),t=e.currentMenu,r=e.setCurrentMenu,a=e.canvasInstanceRef,o=e.canvasIsRender,i=e.currentMenuRef,h=e.historyRef,v=(0,p.useRef)(!1),c=(0,p.useRef)({x:0,y:0}),l=(0,p.useRef)([]),d=(0,p.useRef)(null),g=(0,p.useRef)({color:X.colors[0],size:X.sizes[0]}),m=function(){var R=a.current;R&&(R.on("mouse:down",function(x){if(!(R.getActiveObject()||i.current!==f.arrow)){R.discardActiveObject(),R.getObjects().forEach(function(N){N.selectable=!1,N.hasControls=!1}),R.requestRenderAll(),v.current=!0,c.current=R.getPointer(x.e),l.current=[c.current.x,c.current.y,c.current.x,c.current.y];var k=new b.fabric.Arrow(l.current,{strokeWidth:g.current.size,stroke:g.current.color,id:new Date().valueOf()+"_"+Math.random()*4});k.strokeUniform=!0,d.current=k,R.add(k)}}),R.on("mouse:move",function(x){if(!(R.getActiveObject()||i.current!==f.arrow||!v.current||!d.current)){if(c.current=R.getPointer(x.e),x.e.shiftKey){var k=l.current[0],N=l.current[1],j=c.current.x-k,E=c.current.y-N,F=Math.sqrt(j*j+E*E),U=Math.atan2(E,j)/Math.PI*180;U=parseInt(""+(U+7.5)%360/15)*15;var Y=F*Math.cos(U*Math.PI/180),y=F*Math.sin(U*Math.PI/180);d.current.set({x2:Y+k,y2:y+N})}else{if(!d.current)return;d.current.set({x2:c.current.x,y2:c.current.y})}R.renderAll()}}),R.on("mouse:up",function(){i.current!==f.arrow||!d.current||!v.current||(d.current.setCoords(),v.current=!1,c.current.x===l.current[0]&&c.current.y===l.current[1]?(R.remove(d.current),R.requestRenderAll(),h.current.updateCanvasState(J.add,!0,!1)):(R.setActiveObject(d.current),h.current.updateCanvasState(J.add,!0,!0)))}))};(0,p.useEffect)(function(){a.current&&o&&m()},[a,o]);var w=function(){r(t===f.arrow?f.default:f.arrow)},C=function(R,x){if(a.current){var k=a.current,N=k.getActiveObjects()[0];R===ae.color?(g.current.color=x,N&&N.set("stroke",x)):(g.current.size=x,N&&N.set("strokeWidth",x)),k.renderAll()}};return{handleArrowTrigger:w,handlePaintChange:C,currentMenu:t}},lt=function(){var e=ut(),t=e.handleArrowTrigger,r=e.handlePaintChange,a=e.currentMenu;return(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-arrow",S()({},"tie-image-editor_tool-item--checked",a===f.arrow)),children:(0,n.jsx)(se,{open:a===f.arrow,onChange:r,children:(0,n.jsx)(A,{content:"\u7BAD\u5934",placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:t})})})})},dt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.setCurrentMenu,o=e.canvasIsRender,i=e.currentMenu,h=e.historyRef,v=(0,p.useRef)(!1),c=(0,p.useRef)({x:9,y:0}),l=(0,p.useRef)(null),d=(0,p.useRef)({color:X.colors[0],size:X.sizes[0]}),g=function(){var s=t.current;s&&(s.on("mouse:down",function(R){if(!(s.getActiveObject()||r.current!==f.circle)){v.current=!0;var x=s.getPointer(R.e);c.current.x=x.x,c.current.y=x.y,l.current=new b.fabric.Circle({left:c.current.x,top:c.current.y,originX:"left",originY:"top",radius:x.x-c.current.x,angle:0,fill:"",stroke:d.current.color,strokeWidth:d.current.size}),s.add(l.current)}}),s.on("mouse:move",function(R){if(!(!v.current||r.current!==f.circle)){var x=s.getPointer(R.e),k=Math.max(Math.abs(c.current.y-x.y),Math.abs(c.current.x-x.x))/2;k>l.current.strokeWidth&&(k-=l.current.strokeWidth/2),l.current.set({radius:k}),c.current.x>x.x?l.current.set({originX:"right"}):l.current.set({originX:"left"}),c.current.y>x.y?l.current.set({originY:"bottom"}):l.current.set({originY:"top"}),s.renderAll()}}),s.on("mouse:up",function(R){if(!(!l.current||r.current!==f.circle)){var x=s.getPointer(R.e);x.x===l.current.left&&x.y===l.current.top?(s.remove(l.current),s.requestRenderAll(),h.current.updateCanvasState(J.add,!0,!1)):(s.setActiveObject(l.current),h.current.updateCanvasState(J.add,!0,!0)),v.current=!1,l.current=null}}))};(0,p.useEffect)(function(){var C=t.current;C&&o&&g()},[t,o]);var m=function(){a(r.current===f.circle?f.default:f.circle)},w=function(s,R){if(t.current){var x=t.current,k=x.getActiveObjects()[0];s===ae.color?(d.current.color=R,k&&k.set("stroke",R)):(d.current.size=R,k&&k.set("strokeWidth",R)),x.renderAll()}};return{handleDrawCircle:m,handlePaintChange:w,currentMenu:i}},ft=function(){var e=dt(),t=e.handleDrawCircle,r=e.handlePaintChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-circle",S()({},"tie-image-editor_tool-item--checked",a===f.circle)),children:(0,n.jsx)(se,{open:a===f.circle,onChange:r,children:(0,n.jsx)(A,{content:"\u5706\u5F62",placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:t})})})})})},vt="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E",ht=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.canvasIsRender,a=e.historyRef,o=function(){var h=document.createElement("img");h.src=vt,b.fabric.Object.prototype.transparentCorners=!1,b.fabric.Object.prototype.cornerColor="blue",b.fabric.Object.prototype.cornerStyle="circle";function v(l,d){var g=d.target,m=g.canvas;return m.remove(g),m.requestRenderAll(),a.current.updateCanvasState(J.delete),!0}function c(l,d,g,m,w){var C=24;l.save(),l.translate(d,g),l.rotate(b.fabric.util.degreesToRadians(w.angle)),l.drawImage(h,-C/2,-C/2,C,C),l.restore()}b.fabric.Object.prototype.controls.deleteControl=new b.fabric.Control({x:.5,y:-.5,offsetY:16,cursorStyle:"pointer",mouseUpHandler:v,render:c})};(0,p.useEffect)(function(){t.current&&r&&o()},[t,r])},gt=function(){return ht(),(0,n.jsx)(n.Fragment,{})},pt="tl",mt="tr",Ct="mt",Rt="ml",wt="mr",xt="mb",yt="bl",Mt="br",jt=[pt,mt,Ct,Rt,wt,xt,yt,Mt],pe=function(){};function St(u){return jt.indexOf(u)>=0}function he(u,e){return u>e?"width":"height"}var kt=b.fabric.util.createClass(b.fabric.Rect,{initialize:function(e,t,r){t=z()(z()({},t),r),t.type="cropzone",this.callSuper("initialize",t),this._addEventHandler(),this.canvas=e,this.options=t},canvasEventDelegation:function(e){var t="unregistered",r=this.canvasEventTrigger[e]!==pe;return r?t="registered":[ie.OBJECT_MOVED,ie.OBJECT_SCALED].indexOf(e)<0&&(t="none"),t},canvasEventRegister:function(e,t){this.canvasEventTrigger[e]=t},_addEventHandler:function(){var e;this.canvasEventTrigger=(e={},S()(e,ie.OBJECT_MOVED,pe),S()(e,ie.OBJECT_SCALED,pe),e),this.on({moving:this._onMoving.bind(this),scaling:this._onScaling.bind(this)}),b.fabric.util.addListener(document,"keydown",this._onKeyDown.bind(this)),b.fabric.util.addListener(document,"keyup",this._onKeyUp.bind(this))},_renderCropzone:function(e){var t=7,r=7,a=this.flipX?-1:1,o=this.flipY?-1:1,i=a/this.scaleX,h=o/this.scaleY;e.scale(i,h),this._fillOuterRect(e,"rgba(0, 0, 0, 0.5)"),this.options.lineWidth?(this._fillInnerRect(e),this._strokeBorder(e,"rgb(255, 255, 255)",{lineWidth:this.options.lineWidth})):(this._strokeBorder(e,"rgb(0, 0, 0)",{lineDashWidth:t}),this._strokeBorder(e,"rgb(255, 255, 255)",{lineDashWidth:t,lineDashOffset:r})),e.scale(1/i,1/h)},_render:function(e){this.callSuper("_render",e),this._renderCropzone(e)},_fillOuterRect:function(e,t){var r=this._getCoordinates(),a=r.x,o=r.y;e.save(),e.fillStyle=t,e.beginPath(),e.moveTo(a[1],o[1]),e.lineTo(a[1],o[2]),e.lineTo(a[2],o[2]),e.lineTo(a[2],o[1]),e.lineTo(a[1],o[1]),e.closePath(),e.fill(),e.restore()},_fillInnerRect:function(e){var t=this._getCoordinates(),r=t.x,a=t.y,o=this._caculateInnerPosition(r,(r[2]-r[1])/3),i=this._caculateInnerPosition(a,(a[2]-a[1])/3);e.save(),e.strokeStyle="rgba(255, 255, 255, 0.7)",e.lineWidth=this.options.lineWidth,e.beginPath(),e.moveTo(o[0],i[1]),e.lineTo(o[3],i[1]),e.moveTo(o[0],i[2]),e.lineTo(o[3],i[2]),e.moveTo(o[1],i[0]),e.lineTo(o[1],i[3]),e.moveTo(o[2],i[0]),e.lineTo(o[2],i[3]),e.stroke(),e.closePath(),e.restore()},_caculateInnerPosition:function(e,t){var r=[];return r[0]=e[1],r[1]=e[1]+t,r[2]=e[1]+t*2,r[3]=e[2],r},_getCoordinates:function(){var e=this.canvas,t=this.width,r=this.height,a=this.left,o=this.top,i=t/2,h=r/2,v=e.getHeight(),c=e.getWidth();return{x:[-(i+a),-i,i,i+(c-a-t)].map(Math.ceil),y:[-(h+o),-h,h,h+(v-o-r)].map(Math.ceil)}},_strokeBorder:function(e,t,r){var a=r.lineDashWidth,o=r.lineDashOffset,i=r.lineWidth,h=this.width/2,v=this.height/2;e.save(),e.strokeStyle=t,e.setLineDash&&e.setLineDash([a,a]),o&&(e.lineDashOffset=o),i&&(e.lineWidth=i),e.beginPath(),e.moveTo(-h,-v),e.lineTo(h,-v),e.lineTo(h,v),e.lineTo(-h,v),e.lineTo(-h,-v),e.stroke(),e.restore()},_onMoving:function(){var e=this.height,t=this.width,r=this.left,a=this.top,o=this.canvas.getWidth()-t,i=this.canvas.getHeight()-e;this.left=q(r,0,o),this.top=q(a,0,i),this.canvasEventTrigger[ie.OBJECT_MOVED](this)},_onScaling:function(e){var t=e.transform.corner,r=this.canvas.getPointer(e.e),a=this._calcScalingSizeFromPointer(r,t);this.scale(1).set(a),this.canvasEventTrigger[ie.OBJECT_SCALED](this)},_calcScalingSizeFromPointer:function(e,t){var r=St(t);return r&&this._resizeCropZone(e,t)},adjustRatioCropzoneSize:function(e){var t=e.width,r=e.height,a=e.leftMaker,o=e.topMaker,i=e.maxWidth,h=e.maxHeight,v=e.scaleTo;if(t=i?q(t,1,i):t,r=h?q(r,1,h):r,!this.presetRatio)return this._withShiftKey&&(t>r?r=t:r>t&&(t=r)),{width:t,height:r,left:a(t),top:o(r)};v==="width"?r=t/this.presetRatio:t=r*this.presetRatio;var c=Math.min(i/t,h/r);if(c<=1){var l=[t,r].map(function(g){return g*c}),d=re()(l,2);t=d[0],r=d[1]}return{width:t,height:r,left:a(t),top:o(r)}},_getCropzoneRectInfo:function(){var e=this.canvas,t=e.width,r=e.height,a=this.getBoundingRect(!1,!0),o=a.top,i=a.left,h=a.width,v=a.height;return{rectTop:o,rectLeft:i,rectWidth:h,rectHeight:v,rectRight:i+h,rectBottom:o+v,canvasWidth:t,canvasHeight:r}},_resizeCropZone:function(e,t){var r=e.x,a=e.y,o=this._getCropzoneRectInfo(),i=o.rectWidth,h=o.rectHeight,v=o.rectTop,c=o.rectLeft,l=o.rectBottom,d=o.rectRight,g=o.canvasWidth,m=o.canvasHeight,w={tl:{width:d-r,height:l-a,leftMaker:function(s){return d-s},topMaker:function(s){return l-s},maxWidth:d,maxHeight:l,scaleTo:he(c-r,v-a)},tr:{width:r-c,height:l-a,leftMaker:function(){return c},topMaker:function(s){return l-s},maxWidth:g-c,maxHeight:l,scaleTo:he(r-d,v-a)},mt:{width:i,height:l-a,leftMaker:function(){return c},topMaker:function(s){return l-s},maxWidth:g-c,maxHeight:l,scaleTo:"height"},ml:{width:d-r,height:h,leftMaker:function(s){return d-s},topMaker:function(){return v},maxWidth:d,maxHeight:m-v,scaleTo:"width"},mr:{width:r-c,height:h,leftMaker:function(){return c},topMaker:function(){return v},maxWidth:g-c,maxHeight:m-v,scaleTo:"width"},mb:{width:i,height:a-v,leftMaker:function(){return c},topMaker:function(){return v},maxWidth:g-c,maxHeight:m-v,scaleTo:"height"},bl:{width:d-r,height:a-v,leftMaker:function(s){return d-s},topMaker:function(){return v},maxWidth:d,maxHeight:m-v,scaleTo:he(c-r,a-l)},br:{width:r-c,height:a-v,leftMaker:function(){return c},topMaker:function(){return v},maxWidth:g-c,maxHeight:m-v,scaleTo:he(r-d,a-l)}};return this.adjustRatioCropzoneSize(w[t])},isValid:function(){return this.left>=0&&this.top>=0&&this.width>0&&this.height>0},_onKeyDown:function(e){var t=e.keyCode;t===ve.SHIFT&&(this._withShiftKey=!0)},_onKeyUp:function(e){var t=e.keyCode;t===ve.SHIFT&&(this._withShiftKey=!1)}}),Tt=kt,bt=function(e){var t=e.children,r=e.open,a=r===void 0?!1:r,o=e.onChange,i=function(v){o&&o(v)};return(0,n.jsx)(A,{content:(0,n.jsxs)("div",{className:"tie-image-editor_tool-crop-pop",children:[(0,n.jsx)("i",{className:"tie-image-editor_tool-crop-pop_icon",onClick:function(){return i(!0)}}),(0,n.jsx)("i",{className:"tie-image-editor_tool-crop-pop_icon",onClick:function(){return i(!1)}})]}),placement:"bottom",open:a,children:(0,n.jsx)("div",{children:t})})},Dt=bt,It=10,Pt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.setCurrentMenu,o=e.canvasIsRender,i=e.currentMenu,h=e.wrapperInstanceRef,v=e.historyRef,c=e.unSaveHistory,l=(0,p.useRef)(null),d=(0,p.useRef)(0),g=(0,p.useRef)(0),m=(0,p.useRef)(!1),w=(0,p.useCallback)(function(y,M){var T=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null,L=t.current;if(L){var I=L.getWidth(),P=L.getHeight(),B=d.current,V=g.current,H=q(y,0,B),ee=q(M,0,V),$=q(y,B,I)-H,W=q(M,V,P)-ee;return m.current&&!T?($>W?W=$:W>$&&($=W),B>=y&&(H=B-$),V>=M&&(ee=V-W)):T&&(W=$/T,B>=y&&(H=q(B-$,0,I)),V>=M&&(ee=q(V-W,0,P)),ee+W>P&&(W=P-ee,$=W*T,B>=y&&(H=q(B-$,0,I)),V>=M&&(ee=q(V-W,0,P)))),{left:H,top:ee,width:$,height:W}}},[]),C=(0,p.useCallback)(function(y){r.current===f.crop&&y.keyCode===ve.SHIFT&&(m.current=!0)},[]),s=(0,p.useCallback)(function(y){r.current===f.crop&&y.keyCode===ve.SHIFT&&(m.current=!1)},[]),R=(0,p.useCallback)(function(y){var M=t.current;if(M&&r.current===f.crop){var T=M.getPointer(y.e),L=T.x,I=T.y,P=l.current;P&&Math.abs(L-d.current)+Math.abs(I-g.current)>It&&(M.remove(P),P.set(w(L,I,P.presetRatio)),M.add(P),M.setActiveObject(P))}},[o]),x=(0,p.useCallback)(function(){var y=t.current;if(y&&r.current===f.crop){var M=l.current;y.setActiveObject(M),y.off("mouse:move",R),y.off("mouse:up",x)}},[o]),k=(0,p.useCallback)(function(y){if(!y.target){var M=t.current;if(M&&r.current===f.crop){M.selection=!1;var T=M.getPointer(y.e);d.current=T.x,g.current=T.y,M.on("mouse:move",R),M.on("mouse:up",x)}}},[o]),N=(0,p.useCallback)(function(){var y=t.current;!y||!o||l.current||(c.current=!0,y.getObjects().forEach(function(M){M.evented=!1}),l.current=new Tt(t.current,{left:0,top:0,width:.5,height:.5,strokeWidth:0,cornerSize:16,cornerColor:"blue",fill:"transparent",hasRotatingPoint:!1,hasBorders:!1,lockScalingFlip:!0,lockRotation:!0,lockSkewingX:!0,lockSkewingY:!0,cornerStyle:"circle",cornerStrokeColor:"blue",transparentCorners:!1,lineWidth:2,borderColor:"blue"}),y.discardActiveObject(),y.add(l.current),y.on("mouse:down",k),y.selection=!1,y.defaultCursor="crosshair",b.fabric.util.addListener(document,"keydown",C),b.fabric.util.addListener(document,"keyup",s))},[o]),j=(0,p.useCallback)(function(){var y=t.current;if(y){var M=l.current;M&&(y.remove(M),y.selection=!0,y.defaultCursor="default",y.off("mouse:down",k),y.off("mouse:move",R),y.off("mouse:up",x),y.forEachObject(function(T){T.evented=!0}),l.current=null,b.fabric.util.removeListener(document,"keydown",C),b.fabric.util.removeListener(document,"keyup",s),c.current=!1)}},[o]),E=function(){r.current!==f.crop?N():j(),a(r.current!==f.crop?f.crop:f.default)},F=function(){var M=l.current;return!M||!M.isValid()?null:{left:M.left,top:M.top,width:M.width,height:M.height}},U=function(){var M=t.current;if(M){var T=M.contains(l.current),L=F();if(!L)return null;T&&M.remove(l.current);var I={imageName:xe,url:M.toDataURL(L)};return T&&M.add(l.current),I}},Y=function(M){var T=t.current;if(T)if(!M)j(),N();else{var L=U();if(!L||!L.url.includes("base64"))return;T.clear(),T.setBackgroundImage(L.url,function(){var I=T.backgroundImage,P=h.current.getBoundingClientRect(),B=P.height,V=T.getCenter(),H=I.height;I.scale(B/H),I.set({left:V.left-I.width*(B/H)/2,top:V.top-I.height*(B/H)/2}),I.selectable=!1,I.id=fe,T.renderAll(),j(),v.current.updateCanvasState(J.add),N()})}};return(0,p.useEffect)(function(){i!==f.crop&&l.current&&j()},[i]),{handleCropTrigger:E,handleCropChange:Y,currentMenu:i}},Et=function(){var e=Pt(),t=e.handleCropTrigger,r=e.handleCropChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-crop",S()({},"tie-image-editor_tool-item--checked",a===f.crop)),children:(0,n.jsx)(Dt,{open:a===f.crop,onChange:r,children:(0,n.jsx)(A,{content:"\u88C1\u526A",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:t})})})})})},Ot=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.canvasEl,a=e.onDownLoad,o=function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;console.log("heheh");var v=t.current;if(!v||!r.current)return Promise.reject();var c=v.toDataURL(),l=Date.now()+xe,d,g;if(a)return a({downLoadUrl:c}),Promise.resolve({downLoadUrl:c});if(!h)return Promise.resolve({downLoadUrl:c});if(Ae()&&window.saveAs)d=Ne(c),g=d.type.split("/")[1],l.split(".").pop()!==g&&(l+=".".concat(g)),window.saveAs(d,l);else{l.split(".").pop()!==g&&(l+=".png");var m=document.createElement("a");m.href=c,m.download=l,document.body.appendChild(m),m.click(),m.remove()}return Promise.resolve({downLoadUrl:c})};return{handleDownload:o}},je=(0,p.forwardRef)(function(u,e){var t=Ot(),r=t.handleDownload;return(0,p.useImperativeHandle)(e,function(){return{download:r}},[r]),(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-download",children:(0,n.jsx)(A,{content:"\u4E0B\u8F7D",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:function(){return r(!0)}})})})});je.displayName="Download";var _t=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.wrapperInstanceRef,a=e.canvasIsRender,o=e.currentMenu,i=e.setCurrentMenu,h=(0,p.useRef)(!1);(0,p.useEffect)(function(){h.current=o===f.drag},[i,o]);var v=function(){var s=t.current;s&&(s.selection=!1,s.defaultCursor="grab",s.getObjects().forEach(function(R){R.selectable=!1}),s.requestRenderAll())},c=function(){var s=t.current;s&&(console.log("startDring"),i(f.drag),s.defaultCursor="grab",s.renderAll())},l=function(){var s=t.current;s&&(i(f.default),s.defaultCursor="default",s.isDragging=!1,s.selection=!1,s.renderAll())},d=function(){var s=t.current;s&&(s.on("mouse:down",function(R){var x=R.e;(x.altKey||h.current)&&(s.defaultCursor="grabbing",s.discardActiveObject(),v(),s.selection=!1,s.isDragging=!0,s.lastPosX=x.clientX,s.lastPosY=x.clientY,s.requestRenderAll())}),s.on("mouse:move",function(R){if(s.isDragging){s.discardActiveObject(),s.defaultCursor="grabbing";var x=R.e;if(!s.viewportTransform)return;var k=s.viewportTransform;k[4]+=x.clientX-s.lastPosX,k[5]+=x.clientY-s.lastPosY,s.lastPosX=x.clientX,s.lastPosY=x.clientY,s.requestRenderAll()}}),s.on("mouse:up",function(){!s.viewportTransform||!h.current||(s.setViewportTransform(this.viewportTransform),s.isDragging=!1,s.selection=!0,s.getObjects().forEach(function(R){R.id!==fe&&R.hasControls&&(R.selectable=!0)}),s.defaultCursor="default",s.requestRenderAll())}))},g=function(s){var R=t.current;s.keyCode===32&&R&&!h.current&&c(),s.preventDefault()},m=function(s){var R=t.current;s.keyCode===32&&R&&l()};(0,p.useEffect)(function(){return t.current&&a&&(d(),r.current.tabIndex=1e3,r.current.addEventListener("keydown",g,!1),r.current.addEventListener("keyup",m,!1)),function(){var C=t.current;if(C&&r.current){var s,R;(s=r.current)===null||s===void 0||s.removeEventListener("keydown",g,!1),(R=r.current)===null||R===void 0||R.removeEventListener("keyup",m,!1)}}},[t,a]);var w=function(){i(o!==f.drag?f.drag:f.default)};return{handleMoving:w,currentMenu:o}},At=function(){var e=_t(),t=e.handleMoving,r=e.currentMenu;return(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-hand",S()({},"tie-image-editor_tool-item--checked",r===f.drag)),children:(0,n.jsx)(A,{content:"\u6293\u53D6",placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:t})})})},Nt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.setCurrentMenu,o=e.currentMenu,i=(0,p.useRef)({color:X.colors[0],size:X.sizes[0]}),h=function(){var d=t.current;if(d){d.freeDrawingBrush=new b.fabric.PencilBrush(d);var g=d.freeDrawingBrush;g.color=i.current.color,g.getPatternSrc&&(g.source=g.getPatternSrc.call(g)),g.width=i.current.size,g.shadow=new b.fabric.Shadow({blur:i.current.size,offsetX:0,offsetY:0,affectStroke:!0,color:"#333"})}},v=function(){var d=t.current;d&&(r.current!==f.draw?(d.isDrawingMode=!0,h()):d.isDrawingMode=!1,a(r.current!==f.draw?f.draw:f.default))},c=function(d,g){if(t.current){var m=t.current,w=m.getActiveObjects()[0];d===ae.color?(i.current.color=g,w&&w.set("fill",g)):(i.current.size=g,w&&w.set("width",g)),m.renderAll(),h()}};return{handleDrawTrigger:v,handlePaintChange:c,currentMenu:o}},zt=function(){var e=Nt(),t=e.handleDrawTrigger,r=e.handlePaintChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-draw",S()({},"tie-image-editor_tool-item--checked",a===f.draw)),children:(0,n.jsx)(se,{open:a===f.draw,onChange:r,children:(0,n.jsx)(A,{content:"\u753B\u7B14",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:t})})})})})},Ft=function(e){var t=e.children,r=e.open,a=r===void 0?!1:r,o=e.onChange,i=(0,p.useState)(!1),h=re()(i,2),v=h[0],c=h[1],l=(0,p.useState)(!1),d=re()(l,2),g=d[0],m=d[1],w=function(s,R){s===de.flipX?c(R):m(R),o&&o(s,R)};return(0,n.jsx)(A,{content:(0,n.jsxs)("div",{className:"tie-image-editor_tool-flip-pop",children:[(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-flipX",onClick:function(){return w(de.flipX,!v)},children:(0,n.jsx)("i",{className:"tie-image-editor_icon"})}),(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-flipY",onClick:function(){return w(de.flipY,!g)},children:(0,n.jsx)("i",{className:"tie-image-editor_icon"})})]}),placement:"bottom",open:a,children:(0,n.jsx)("div",{children:t})})},Bt=Ft,Lt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.setCurrentMenu,o=e.canvasIsRender,i=e.currentMenu,h=e.historyRef;(0,p.useEffect)(function(){var l=t.current},[o]);var v=function(){a(r.current!==f.flip?f.flip:f.default)},c=function(d,g){var m=t.current;if(m){m.getObjects().forEach(function(s){s.originalPoint=s.originalPoint||{left:s.left,top:s.top};var R=S()({},d,g);d===de.flipX?g?R=z()(z()({},R),{},{left:m.width-s.originalPoint.left-s.width}):R=z()(z()({},R),{},{left:s.originalPoint.left}):g?R=z()(z()({},R),{},{top:m.height-s.originalPoint.top-s.height}):R=z()(z()({},R),{},{top:s.originalPoint.top}),s.set(R).rotate(parseFloat((s.angle*-1).toString())).setCoords()});var w=m.backgroundImage,C=w.angle;g&&(C*=-1),w.set(S()({},d,g)),w.rotate(parseFloat(C)).setCoords(),w.setCoords(),m.renderAll(),h.current.updateCanvasState(J.add)}};return{handleFlipTrigger:v,handleFlipChange:c,currentMenu:i}},Ht=function(){var e=Lt(),t=e.handleFlipTrigger,r=e.handleFlipChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-flip",S()({},"tie-image-editor_tool-item--checked",a===f.flip)),children:(0,n.jsx)(Bt,{open:a===f.flip,onChange:r,children:(0,n.jsx)(A,{content:"\u7FFB\u8F6C",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:t})})})})})},Wt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.canvasIsRender,a=e.currentMenuRef,o=e.initCanvasJson,i=e.unSaveHistory,h=(0,p.useState)([]),v=re()(h,2),c=v[0],l=v[1],d=(0,p.useState)(""),g=re()(d,2),m=g[0],w=g[1],C=(0,p.useCallback)(function(j){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(!(!t.current||i.current)){var U=t.current;try{var Y=U.toJSON(ge),y=JSON.stringify(Y),M=Date.now()+"_"+Math.floor(Math.random()*1e4),T=c.findIndex(function(I){var P=I.id,B=P===void 0?"":P;return B===m}),L=c.slice(0,T+1-+E).concat(F||!E&&!F?[{id:M,data:y,type:j!==J.delete?a.current:f.default,action:j}]:[]);l(L.slice(Math.max(0,c.length-Pe))),w(M)}catch(I){console.error(I)}}},[c,m]),s=(0,p.useCallback)(function(j){j.target.id===fe||j.action===void 0&&j.e||C(J.modified)},[C]),R=(0,p.useCallback)(function(j){j.action===void 0&&j.e||C(J.add)},[C]);(0,p.useEffect)(function(){var j=t.current;if(j)return j&&r&&(j.on("object:modified",s),j.on("object:added",R)),function(){j.off("object:modified",s),j.off("object:added",R)}},[t,r,s,R]);var x=(0,p.useCallback)(function(){var j,E=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",F=t.current;if(F&&E!==m){var U=((j=c.find(function(Y){var y=Y.id;return y===E}))===null||j===void 0?void 0:j.data)||o.current;i.current=!0,F.loadFromJSON(U,function(){F.renderAll(),i.current=!1}),w(E)}},[m,c]),k=(0,p.useCallback)(function(){if(!(!t.current||!c.length)){var j="";if(m)c.forEach(function(F,U){var Y=F.id;if(Y===m){var y;j=(y=c[U+1])===null||y===void 0?void 0:y.id}});else{var E;j=(E=c[0])===null||E===void 0?void 0:E.id}x(j)}},[m,c]),N=(0,p.useCallback)(function(){if(!(!t.current||!c.length)){var j="";c.forEach(function(E,F){var U=E.id;if(U===m){var Y;j=(Y=c[F-1])===null||Y===void 0?void 0:Y.id}}),x(j)}},[m,c]);return{history:c,currentId:m,renderNewCanvas:x,handleRedo:k,handleUndo:N,updateCanvasState:C}},Se=(0,p.forwardRef)(function(u,e){var t,r,a=Wt(),o=a.history,i=a.currentId,h=a.renderNewCanvas,v=a.handleRedo,c=a.handleUndo,l=a.updateCanvasState;return(0,p.useImperativeHandle)(e,function(){return{updateCanvasState:l}}),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-history",{"tie-image-editor_tool-item--disabled":!o.length}),children:(0,n.jsx)(A,{content:(0,n.jsxs)("div",{className:"tie-image-editor-history_pop",children:[!!o.length&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"tie-image-editor-history_pop-title",children:["\u5386\u53F2",(0,n.jsxs)("span",{className:"tie-image-editor-history_pop-len",children:["\uFF08",o.length,"\uFF09"]})]}),(0,n.jsxs)("div",{onClick:function(){return h("")},className:O()("tie-image-editor-history_pop-item",{"tie-image-editor-history_pop-item--checked":!i}),children:[(0,n.jsx)("span",{className:"tie-image-editor-history_pop-item-num",children:"1."}),"\u521D\u59CB\u5316",!i&&(0,n.jsx)("i",{className:"tie-image-editor-history_pop-item-icon"})]})]}),!o.length&&(0,n.jsx)("span",{children:"\u6682\u65E0\u5386\u53F2"}),o.map(function(d,g){var m=d.action,w=m===void 0?"":m,C=d.id,s=d.type;return(0,n.jsxs)("div",{onClick:function(){return h(C)},className:O()("tie-image-editor-history_pop-item",{"tie-image-editor-history_pop-item--checked":C===i}),children:[(0,n.jsxs)("span",{className:"tie-image-editor-history_pop-item-num",children:[g+2,"."]}),Ie[w],we[s],C===i&&(0,n.jsx)("i",{className:"tie-image-editor-history_pop-item-icon"})]},C)})]}),placement:"bottom",className:"tie-image-editor-history_target",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon")})})}),(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-redo",{"tie-image-editor_tool-item--disabled":!o.length||i===((t=o[o.length-1])===null||t===void 0?void 0:t.id)}),children:(0,n.jsx)(A,{content:"\u524D\u8FDB",placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:!o.length||i===((r=o[o.length-1])===null||r===void 0?void 0:r.id)?void 0:v})})}),(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-undo",{"tie-image-editor_tool-item--disabled":!o.length||!i}),children:(0,n.jsx)(A,{content:"\u56DE\u9000",placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:!o.length||!i?void 0:c})})})]})});Se.displayName="History";var Xt=function(e){var t=e.children,r=e.open,a=r===void 0?!1:r,o=e.onChange,i=function(v){o&&o(v)};return(0,n.jsx)(A,{content:(0,n.jsx)("div",{className:"tie-image-editor_tool-crop-pop",children:(0,n.jsx)("div",{className:"tie-image-editor_tool-paint-size-wrapper",children:X.mosaicSizes.map(function(h,v){return(0,n.jsx)("div",{onClick:function(){return i(h)},className:"tie-image-editor_tool-paint-size",style:{width:10+v*5,height:10+v*5}},h)})})}),placement:"bottom",open:a,children:(0,n.jsx)("div",{children:t})})},Jt=Xt,ce=X.mosaicSizes[0],Ut=function(e){var t=e.data,r=e.height,a=e.width,o,i,h,v,c,l,d,g,m,w,C;for(i=0;i<r;i+=ce)for(h=0;h<a;h+=ce)for(o=i*4*a+h*4,v=t[o],c=t[o+1],l=t[o+2],d=t[o+3],w=Math.min(i+ce,r),C=Math.min(h+ce,a),g=i;g<w;g++)for(m=h;m<C;m++)o=g*4*a+m*4,t[o]=v,t[o+1]=c,t[o+2]=l,t[o+3]=d},Yt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.canvasIsRender,a=e.currentMenu,o=e.currentMenuRef,i=e.setCurrentMenu,h=(0,p.useRef)(null),v=(0,p.useCallback)(function(){var d=t.current;d&&(h.current=new b.fabric.PatternBrush(d),h.current.getPatternSrc=function(){var g={left:0,top:0,width:d.width,height:d.height},m=d.toCanvasElement(1,g),w=m.getContext("2d"),C=w.getImageData(0,0,m.width,m.height);Ut(C),w.putImageData(C,0,0);var s=b.fabric.document.createElement("canvas"),R=s.getContext("2d");return s.width=d.width||0,s.height=d.height||0,R.drawImage(m,0,0,m.width,m.height,g.left,g.top,g.width,g.height),s})},[]);(0,p.useEffect)(function(){r&&v()},[r]);var c=(0,p.useCallback)(function(){var d=t.current;if(d){if(o.current!==f.mosaic){d.isDrawingMode=!0,d.freeDrawingBrush=h.current;var g=d.freeDrawingBrush;g.getPatternSrc&&(g.source=g.getPatternSrc.call(g)),g.width=30,g.shadow=new b.fabric.Shadow({blur:0,offsetX:0,offsetY:0,affectStroke:!0})}else d.isDrawingMode=!1;i(o.current===f.mosaic?f.default:f.mosaic)}},[v]),l=function(g){var m=t.current;if(m){ce=g;var w=m.freeDrawingBrush;w.getPatternSrc&&(w.source=w.getPatternSrc.call(w))}};return{currentMenu:a,handleMosaicTrigger:c,handleSizeChange:l}},Vt=function(){var e=Yt(),t=e.currentMenu,r=e.handleMosaicTrigger,a=e.handleSizeChange;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-mosaic",S()({},"tie-image-editor_tool-item--checked",t===f.mosaic)),children:(0,n.jsx)(Jt,{open:t===f.mosaic,onChange:a,children:(0,n.jsx)(A,{content:"\u9A6C\u8D5B\u514B",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:r})})})})})},Kt=Vt,Gt=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.canvasIsRender,o=e.currentMenu,i=e.historyRef,h=e.setCurrentMenu,v=(0,p.useRef)(!1),c=(0,p.useRef)({x:9,y:0}),l=(0,p.useRef)(null),d=(0,p.useRef)({color:X.colors[0],size:X.sizes[0]}),g=function(){var s=t.current;s&&(s.on("mouse:down",function(R){if(s.getActiveObject()||r.current!==f.rect)return!1;v.current=!0;var x=s.getPointer(R.e);c.current.x=x.x,c.current.y=x.y,l.current=new b.fabric.Rect({left:c.current.x,top:c.current.y,originX:"left",originY:"top",width:x.x-c.current.x,height:x.y-c.current.y,angle:0,fill:"rgba(255,0,0,0)",stroke:d.current.color,strokeWidth:d.current.size,transparentCorners:!1}),s.add(l.current)}),s.on("mouse:move",function(R){if(!(!v.current||!l.current||r.current!==f.rect)){var x=s.getPointer(R.e);c.current.x>x.x&&l.current.set({left:Math.abs(x.x)}),c.current.y>x.y&&l.current.set({top:Math.abs(x.y)}),l.current.set({width:Math.abs(c.current.x-x.x)}),l.current.set({height:Math.abs(c.current.y-x.y)}),s.renderAll()}}),s.on("mouse:up",function(R){if(!(!l.current||r.current!==f.rect)){var x=s.getPointer(R.e);x.x===l.current.left&&x.y===l.current.top?(s.remove(l.current),s.requestRenderAll(),i.current.updateCanvasState(J.add,!0,!1)):(s.setActiveObject(l.current),i.current.updateCanvasState(J.add,!0,!0)),v.current=!1,l.current=null}}))};(0,p.useEffect)(function(){t.current&&a&&g()},[t,a]);var m=function(){h(r.current===f.rect?f.default:f.rect)},w=function(s,R){if(t.current){var x=t.current,k=x.getActiveObjects()[0];s===ae.color?(d.current.color=R,k&&k.set("stroke",R)):(d.current.size=R,k&&k.set("strokeWidth",R)),x.renderAll()}};return{handleDrawRect:m,handlePaintChange:w,currentMenu:o}},Zt=function(){var e=Gt(),t=e.handleDrawRect,r=e.handlePaintChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-rect",S()({},"tie-image-editor_tool-item--checked",a===f.rect)),children:(0,n.jsx)(se,{open:a===f.rect,onChange:r,children:(0,n.jsx)(A,{content:"\u77E9\u5F62",placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:t})})})})})},$t=function(){var e=(0,p.useContext)(G),t=e.setCurrentMenu,r=e.initCanvasJson,a=e.currentMenuRef,o=e.canvasInstanceRef,i=e.historyRef,h=function(){a.current!==f.reset&&t(f.reset);var c=o.current;if(c){c.clear();var l=c.getCenter();c.zoomToPoint(new b.fabric.Point(l.left,l.top),1),c.clear().renderAll(),c.loadFromJSON(JSON.parse(r.current),function(){c.renderAll(),i.current.updateCanvasState(J.add)})}};return{handleReset:h}},Qt=function(){var e=$t(),t=e.handleReset;return(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-reset",children:(0,n.jsx)(A,{content:"\u91CD\u7F6E",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:t})})})},qt=D(15560),yr=D(39843),er=function(e){var t=e.children,r=e.open,a=r===void 0?!1:r,o=e.onChange,i=(0,p.useState)(X.rotates[0]),h=re()(i,2),v=h[0],c=h[1],l=function(g){c(+g),o&&o(+g)};return(0,n.jsx)(A,{content:(0,n.jsx)("div",{className:"tie-image-editor_tool-rotate-pop-content",children:(0,n.jsx)(qt.Z,{min:X.rotates[0],max:X.rotates[X.rotates.length-1],onChange:l,value:v,marks:X.rotates.reduce(function(d,g){return z()(z()({},d),{},S()({},g,g+"\xB0"))},{})})}),placement:"bottom-end",open:a,children:(0,n.jsx)("div",{children:t})})},tr=er,rr=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.setCurrentMenu,o=e.canvasIsRender,i=e.currentMenu,h=e.historyRef;(0,p.useEffect)(function(){var l=t.current},[o]);var v=function(){a(r.current!==f.rotate?f.rotate:f.default)},c=function(d){var g=t.current;if(g){g.getObjects().forEach(function(w){w.originalPoint=w.originalPoint||new b.fabric.Point(w.left,w.top);var C=b.fabric.util.rotatePoint(w.originalPoint,g.getVpCenter(),b.fabric.util.degreesToRadians(d));w.set({left:C.x,top:C.y,angle:d})});var m=g.backgroundImage;m.rotate(d),m.setCoords(),g.requestRenderAll(),h.current.updateCanvasState(J.add)}};return{handleRotateTrigger:v,handleRotateChange:c,currentMenu:i}},nr=function(){var e=rr(),t=e.handleRotateTrigger,r=e.handleRotateChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-rotate",S()({},"tie-image-editor_tool-item--checked",a===f.rotate)),children:(0,n.jsx)(tr,{open:a===f.rotate,onChange:r,children:(0,n.jsx)(A,{content:"\u65CB\u8F6C",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:t})})})})})},ar=function(e){var t=e.children,r=e.open,a=r===void 0?!1:r,o=e.zoom,i=o===void 0?1:o,h=e.onScaleUp,v=e.onScaleDown,c=e.onReset;return(0,n.jsx)(A,{content:(0,n.jsxs)("div",{className:"tie-image-editor_tool-scale-pop-content",children:[(0,n.jsxs)("div",{className:"tie-image-editor_tool-scale-pop-zoom",children:[+(i*100).toFixed(0),"%"]}),(0,n.jsxs)("div",{className:"tie-image-editor_tool-scale-pop-icons",children:[(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-subtract",children:(0,n.jsx)("i",{className:"tie-image-editor_tool-scale-pop-icon tie-image-editor_icon",onClick:v})}),(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-add",children:(0,n.jsx)("i",{className:"tie-image-editor_tool-scale-pop-icon tie-image-editor_icon",onClick:h})})]}),(0,n.jsx)("button",{onClick:c,children:"\u91CD\u7F6E"})]}),placement:"bottom-end",open:a,showArrow:!1,children:(0,n.jsx)("div",{children:t})})},ir=ar,or=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.canvasIsRender,a=e.currentMenu,o=e.currentMenuRef,i=e.zoom,h=e.setZoom,v=e.setCurrentMenu;(0,p.useEffect)(function(){var m=t.current;m&&r&&m.on("mouse:wheel",function(w){var C=w.e.deltaY,s=m.getZoom();s*=Math.pow(.999,C),s>20&&(s=20),s<.01&&(s=.01),h(s),m.requestRenderAll(),w.e.preventDefault(),w.e.stopPropagation()})},[t,r]),(0,p.useEffect)(function(){var m=t.current;if(m){var w=m.getCenter();m.zoomToPoint(new b.fabric.Point(w.left,w.top),i<0?.01:i),o.current!==f.scale&&v(f.scale)}},[i]);var c=function(){if(t.current){var w=t.current,C=w.getZoom();C+=.05,h(C)}},l=function(){if(t.current){var w=t.current,C=w.getZoom();C-=.05,h(C)}},d=function(){v(o.current===f.scale?f.default:f.scale)},g=function(){h(1)};return{currentMenu:a,zoom:i,handleScaleUp:c,handleScaleDown:l,handleScaleTrigger:d,handleReset:g}},sr=function(){var e=or(),t=e.zoom,r=e.currentMenu,a=e.handleScaleDown,o=e.handleScaleUp,i=e.handleScaleTrigger,h=e.handleReset;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-zoomIn",S()({},"tie-image-editor_tool-item--checked",r===f.scale)),children:(0,n.jsx)(ir,{open:r===f.scale,zoom:t,onScaleDown:a,onScaleUp:o,onReset:h,children:(0,n.jsx)(A,{content:we.scale,placement:"top",children:(0,n.jsx)("i",{className:O()("tie-image-editor_icon"),onClick:i})})})})})},cr=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.currentMenuRef,a=e.setCurrentMenu,o=e.canvasIsRender,i=e.currentMenu,h=(0,p.useRef)({color:X.colors[0],size:X.fontSizes[0]}),v=(0,p.useCallback)(function(g){var m=t.current;if(m&&!(m.getActiveObject()||r.current!==f.text)){var w=m.getPointer(g.e),C=new b.fabric.IText("\u8F93\u5165\u5185\u5BB9",{left:w.x,top:w.y,fontSize:h.current.size,id:Math.random()*4+"_"+Date.now(),fill:h.current.color});m.add(C),m.setActiveObject(C),m.renderAll()}},[]),c=function(){var m=t.current;m&&m.on("mouse:up",v)};(0,p.useEffect)(function(){var g=t.current;if(!(!g||!o))return c(),function(){g.off("mouse:up",v)}},[o]);var l=function(){a(r.current!==f.text?f.text:f.default)},d=function(m,w){if(t.current){var C=t.current,s=C.getActiveObjects()[0];m===ae.color?(h.current.color=w,s&&s.set("fill",w)):(h.current.size=w,s&&s.set("fontSize",w)),C.renderAll()}};return{handleTextTrigger:l,handlePaintChange:d,currentMenu:i}},ur=function(){var e=cr(),t=e.handleTextTrigger,r=e.handlePaintChange,a=e.currentMenu;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:O()("tie-image-editor_tool-item tie-image-editor_tool-text",S()({},"tie-image-editor_tool-item--checked",a===f.text)),children:(0,n.jsx)(se,{open:a===f.text,onChange:r,type:f.text,children:(0,n.jsx)(A,{content:"\u6587\u5B57",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",onClick:t})})})})})},lr=function(){var e=(0,p.useContext)(G),t=e.canvasInstanceRef,r=e.canvasEl,a=e.currentMenuRef,o=e.historyRef,i=e.setCurrentMenu,h=e.initBackGroundImage,v=function(l){var d,g=t.current;if(!(!g||!r.current||!l.target.files.length||!((d=l.target.files[0])!==null&&d!==void 0&&(d=d.type)!==null&&d!==void 0&&d.includes("image")))){a.current!==f.upload&&i(f.upload);var m=new FileReader;m.onload=function(w){if(!(!w||!w.target)){var C=new Image;C.src=w.target.result,h(w.target.result,!0,function(){o.current.updateCanvasState(J.add)})}},m.readAsDataURL(l.target.files[0])}};return{handleUpload:v}},dr=function(){var e=lr(),t=e.handleUpload;return(0,n.jsx)("div",{className:"tie-image-editor_tool-item tie-image-editor_tool-upload",children:(0,n.jsx)(A,{content:"\u4E0A\u4F20",placement:"top",children:(0,n.jsx)("i",{className:"tie-image-editor_icon",children:(0,n.jsx)("input",{onChange:t,type:"file",className:"tie-image-editor_tool-upload-input",accept:"image/*"})})})})},fr=function(e){var t=e.url,r=(0,p.useRef)(null),a=(0,p.useRef)(),o=(0,p.useRef)(),i=(0,p.useRef)(null),h=(0,p.useState)(!1),v=re()(h,2),c=v[0],l=v[1],d=(0,p.useState)(f.default),g=re()(d,2),m=g[0],w=g[1],C=(0,p.useRef)(f.default),s=(0,p.useRef)("{}"),R=(0,p.useRef)(!1),x=(0,p.useRef)({updateCanvasState:function(){}}),k=(0,p.useRef)({downLoad:function(){return Promise.resolve({})}}),N=(0,p.useState)(1),j=re()(N,2),E=j[0],F=j[1],U=function(T){w(T),C.current=T,![f.draw,f.mosaic].includes(T)&&o.current&&o.current.isDrawingMode&&(o.current.isDrawingMode=!1)},Y=function(){if(i.current&&r.current)try{var T=i.current.getBoundingClientRect(),L=T.width,I=T.height,P=new b.fabric.Canvas(r.current,{containerClass:"tie-image-editor_canvas",width:L,height:I});o.current=P,l(!0);try{s.current=JSON.stringify(P.toJSON(ge))}catch(B){console.error("initCanvasJson \u521D\u59CB\u5316\u5931\u8D25")}}catch(B){console.error(B)}},y=function(){var T=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",L=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,I=arguments.length>2?arguments[2]:void 0,P=o.current;if(T.trim()&&P&&i.current){var B=i.current.getBoundingClientRect(),V=B.height;a.current=b.fabric.Image.fromURL(T,function(H){var ee=P.getCenter(),$=H.height;if(H.scale(V/$),H.set({left:ee.left-H.width*(V/$)/2,top:ee.top-H.height*(V/$)/2}),H.selectable=!1,H.id=fe,P.setBackgroundImage(H,P.renderAll.bind(P)),L){I&&I();return}try{s.current=JSON.stringify(P.toJSON(ge))}catch(W){console.error("initCanvasJson \u521D\u59CB\u5316\u5931\u8D25")}I&&I()},{crossOrigin:"anonymous"})}};return(0,p.useEffect)(function(){Y()},[r,i]),(0,p.useEffect)(function(){y(t)},[t,o,i]),{canvasEl:r,imageInstanceRef:a,canvasInstanceRef:o,wrapperInstanceRef:i,currentMenu:m,setCurrentMenu:U,currentMenuRef:C,canvasIsRender:c,initCanvasJson:s,unSaveHistory:R,historyRef:x,initBackGroundImage:y,downloadRef:k,zoom:E,setZoom:F}},ke=(0,p.forwardRef)(function(u,e){var t=u.url,r=t===void 0?Ee:t,a=u.style,o=u.menus,i=o===void 0?Oe:o,h=u.onDownLoad,v=fr({url:r}),c=v.canvasEl,l=v.canvasInstanceRef,d=v.wrapperInstanceRef,g=v.currentMenu,m=v.setCurrentMenu,w=v.currentMenuRef,C=v.canvasIsRender,s=v.initCanvasJson,R=v.unSaveHistory,x=v.historyRef,k=v.initBackGroundImage,N=v.downloadRef,j=v.zoom,E=v.setZoom;return(0,p.useImperativeHandle)(e,function(){return{downloadRef:N}},[]),(0,n.jsx)(G.Provider,{value:{canvasInstanceRef:l,wrapperInstanceRef:d,currentMenuRef:w,currentMenu:g,setCurrentMenu:m,canvasIsRender:C,canvasEl:c,url:r,onDownLoad:h,initCanvasJson:s,unSaveHistory:R,historyRef:x,initBackGroundImage:k,zoom:j,setZoom:E},children:(0,n.jsxs)("div",{className:"tie-image-editor",style:a,children:[(0,n.jsx)(gt,{}),(0,n.jsxs)("div",{className:"tie-image-editor_tool clearfix",children:[(!i.length||i.includes(f.rect))&&(0,n.jsx)(Zt,{}),(!i.length||i.includes(f.circle))&&(0,n.jsx)(ft,{}),(!i.length||i.includes(f.arrow))&&(0,n.jsx)(lt,{}),(!i.length||i.includes(f.draw))&&(0,n.jsx)(zt,{}),(!i.length||i.includes(f.text))&&(0,n.jsx)(ur,{}),(!i.length||i.includes(f.mosaic))&&(0,n.jsx)(Kt,{}),(!i.length||i.includes(f.crop))&&(0,n.jsx)(Et,{}),(!i.length||i.includes(f.download))&&(0,n.jsx)(je,{ref:N}),(!i.length||i.includes(f.upload))&&(0,n.jsx)(dr,{}),(!i.length||i.includes(f.drag))&&(0,n.jsx)(At,{}),(!i.length||i.includes(f.reset))&&(0,n.jsx)(Qt,{}),(!i.length||i.includes(f.rotate))&&(0,n.jsx)(nr,{}),(!i.length||i.includes(f.flip))&&(0,n.jsx)(Ht,{}),(!i.length||i.includes(f.scale))&&(0,n.jsx)(sr,{}),(!i.length||i.includes(f.history))&&(0,n.jsx)(Se,{ref:x})]}),(0,n.jsx)("div",{ref:d,className:"tie-image-editor_modal__wrapper",children:(0,n.jsx)("canvas",{ref:c})})]})})});ke.displayName="Editor";var vr=D.p+"static/basic.1cfbd9e1.jpg",hr=function(){return(0,n.jsx)("div",{children:(0,n.jsx)(ke,{url:vr})})},gr=hr},24960:function(){},26759:function(){},56272:function(){}}]);
